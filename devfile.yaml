schemaVersion: 2.2.0

metadata:
  name: hcl-dx-workspace-pro
  displayName: "HCL DX & React Environment"
  description: "Full Stack Environment with Java, React, HCL DXClient, and HCL DX Extensions."
  icon: "https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg"

components:
  - name: tools
    container:
      image: quay.io/agorostidi/europesip-udi-dx:latest
      memoryLimit: 6Gi
      mountSources: true

      # Keep container alive (avoids CrashLoop)
      command: ["/bin/sh", "-c", "tail -f /dev/null"]

      # Environment variables for Java + Node
      env:
        - name: JAVA_HOME
          value: /usr/lib/jvm/java-17-openjdk
        - name: PATH
          value: /usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin:/home/tooling/.nvm/versions/node/v20.18.1/bin

      # Exposed ports for the workspace
      endpoints:
        - name: "react-app"
          targetPort: 3000
          exposure: public
          protocol: http
        - name: "vite-app"
          targetPort: 5173
          exposure: public
          protocol: http
        - name: "java-backend"
          targetPort: 8080
          exposure: public

commands:

  ###########################################################################
  # 1) Install LOCAL HCL DX Extension
  #
  # NOTE:
  # This extension is NOT available in OpenVSX.
  # Therefore, we install it manually from /opt/extensions/*.vsix
  # using a local workaround.
  ###########################################################################
  - id: install-local-dx-extension
    exec:
      label: "üîß Install Local HCL DX Extension (Workaround)"
      component: tools
      commandLine: |
        EXT_DIR="$HOME/.vscode/extensions"
        mkdir -p "$EXT_DIR"

        echo "--> Searching for HCL DX VSIX packages in /opt/extensions..."

        for vsix in /opt/extensions/*hcl-dx*.vsix; do
          if [ -f "$vsix" ]; then
            FILENAME=$(basename "$vsix" .vsix)
            TARGET="$EXT_DIR/$FILENAME"

            # CACHE CHECK: Skip if already installed
            if [ -d "$TARGET" ]; then
                echo "‚ö†Ô∏è  Local HCL DX extension '$FILENAME' already installed. Skipping."
                continue
            fi

            echo "üì¶ Installing local HCL DX extension: $FILENAME"
            unzip -q "$vsix" -d "$TARGET.tmp"

            if [ -d "$TARGET.tmp/extension" ]; then
                mv "$TARGET.tmp/extension" "$TARGET"
                rm -rf "$TARGET.tmp"
                echo "   ‚úîÔ∏è Installed: $FILENAME"
            else
                echo "   ‚ùå Invalid VSIX format for $FILENAME"
            fi
          fi
        done

        echo "üéâ Local HCL DX extension installation completed."


  ###########################################################################
  # 2) Initialize SAMPLE PROJECT
  ###########################################################################
  - id: init-sample-project
    exec:
      label: "üöÄ Initialize HCL DX Sample Project"
      component: tools
      workingDir: /projects
      commandLine: |
        SOURCE="/opt/samples/dx-create-script-app"
        DEST="/projects/dx-create-script-app"

        if [ -d "$DEST" ]; then
            echo "‚ö†Ô∏è  Project already exists: $DEST"
        else
            echo "üìÇ Copying sample project..."
            cp -r "$SOURCE" "$DEST"
            echo "   ‚úîÔ∏è Project created at: $DEST"
        fi


  ###########################################################################
  # 3) Diagnostic tool versions
  ###########################################################################
  - id: check-versions
    exec:
      label: "üîç Check Tool Versions"
      component: tools
      workingDir: /projects
      commandLine: |
        echo "--- JAVA VERSION ---"
        java -version
        echo "--- NODE VERSION ---"
        node -v
        echo "--- HCL DX CLIENT ---"
        dxclient --version


  ###########################################################################
  # 4) Start React
  ###########################################################################
  - id: start-react
    exec:
      label: "‚ñ∂Ô∏è Start React App"
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: "npm start"


  ###########################################################################
  # 5) Install ALL VSCode Extensions from OpenVSX (Parallel + Cached)
  #
  # NOTE:
  # All extensions below come directly from OpenVSX.org
  # including HCL AppScan CodeSweep.
  #
  # We also support:
  # - Parallel downloads (each extension installs in background)
  # - Cache detection (skips if installed)
  ###########################################################################
  - id: install-openvsx-extensions
    exec:
      label: "üîå Install VSCode Extensions (OpenVSX, Parallel + Cache)"
      component: tools
      commandLine: |
        EXT_DIR="$HOME/.vscode/extensions"
        mkdir -p "$EXT_DIR"

        # Parallel installer function
        install_vsix () {
          NAME="$1"
          URL="$2"
          TARGET="$EXT_DIR/$NAME"

          # Skip if already installed
          if [ -d "$TARGET" ]; then
            echo "‚ö†Ô∏è  $NAME already installed. Skipping."
            return
          fi

          echo "üì¶ Installing $NAME from OpenVSX..."
          (
            wget -q "$URL" -O /tmp/ext.vsix
            unzip -q /tmp/ext.vsix -d "$TARGET.tmp"

            if [ -d "$TARGET.tmp/extension" ]; then
              mv "$TARGET.tmp/extension" "$TARGET"
              rm -rf "$TARGET.tmp"
              echo "   ‚úîÔ∏è Installed: $NAME"
            else
              echo "   ‚ùå Invalid VSIX for: $NAME"
              rm -rf "$TARGET.tmp"
            fi
          ) &
        }

        echo "üîΩ Downloading all VSCode extensions from OpenVSX..."

        # Java
        install_vsix "redhat.java" \
          "https://open-vsx.org/api/redhat/java/latest/file/redhat.java.vsix"

        # Java Debug
        install_vsix "vscjava.vscode-java-debug" \
          "https://open-vsx.org/api/vscjava/vscode-java-debug/latest/file/vscjava.vscode-java-debug.vsix"

        # Maven
        install_vsix "vscjava.vscode-maven" \
          "https://open-vsx.org/api/vscjava/vscode-maven/latest/file/vscjava.vscode-maven.vsix"

        # React Snippets
        install_vsix "dsznajder.es7-react-js-snippets" \
          "https://open-vsx.org/api/dsznajder/es7-react-js-snippets/latest/file/dsznajder.es7-react-js-snippets.vsix"

        # Angular
        install_vsix "Angular.ng-template" \
          "https://open-vsx.org/api/Angular/ng-template/latest/file/Angular.ng-template.vsix"

        # Prettier
        install_vsix "esbenp.prettier-vscode" \
          "https://open-vsx.org/api/esbenp/prettier-vscode/latest/file/esbenp.prettier-vscode.vsix"

        # ESLint
        install_vsix "dbaeumer.vscode-eslint" \
          "https://open-vsx.org/api/dbaeumer/vscode-eslint/latest/file/dbaeumer.vscode-eslint.vsix"

        # GitLens
        install_vsix "eamodio.gitlens" \
          "https://open-vsx.org/api/eamodio/gitlens/latest/file/eamodio.gitlens.vsix"

        # YAML
        install_vsix "redhat.vscode-yaml" \
          "https://open-vsx.org/api/redhat/vscode-yaml/latest/file/redhat.vscode-yaml.vsix"

        # Docker
        install_vsix "ms-azuretools.vscode-docker" \
          "https://open-vsx.org/api/ms-azuretools/vscode-docker/latest/file/ms-azuretools.vscode-docker.vsix"

        # EditorConfig
        install_vsix "EditorConfig.EditorConfig" \
          "https://open-vsx.org/api/EditorConfig/EditorConfig/latest/file/EditorConfig.EditorConfig.vsix"

        # Markdown All-in-One
        install_vsix "yzhang.markdown-all-in-one" \
          "https://open-vsx.org/api/yzhang/markdown-all-in-one/latest/file/yzhang.markdown-all-in-one.vsix"

        # HCL AppScan CodeSweep (available in OpenVSX)
        install_vsix "HCLTechnologies.hclappscancodesweep" \
          "https://open-vsx.org/api/HCLTechnologies/hclappscancodesweep/latest/file/HCLTechnologies.hclappscancodesweep.vsix"

        # Wait for all background jobs
        wait

        echo "üéâ All OpenVSX extensions installed."


###############################################################################
# EVENTS: Launch local HCL DX extension first, then OpenVSX extensions
###############################################################################
events:
  postStart:
    - install-local-dx-extension     # Local workaround ‚Üí HCL DX Extension not in OpenVSX
  postStartAsync:
    - install-openvsx-extensions     # All other extensions installed from OpenVSX
