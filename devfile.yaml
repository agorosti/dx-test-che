schemaVersion: 2.2.0
metadata:
  name: hcl-dx-workspace-pro
  displayName: "HCL DX & React Environment"
  description: "Full Stack Environment with Java, React, HCL DXClient, and HCL DX Extensions."
  icon: "https://upload.wikimedia.org/wikipedia/commons/a/a7/React-icon.svg"

# -------------------------------------------------------------------------
# 1. COMPONENTS
# -------------------------------------------------------------------------
components:
  - name: tools
    container:
      # Public image shared on Quay (based on standar UDI)
      image: quay.io/agorostidi/europesip-udi-dx:latest
      memoryLimit: 6Gi
      mountSources: true
      
      # Avoid CrashLoop
      command: ["/bin/sh", "-c", "tail -f /dev/null"]

      env:
        - name: JAVA_HOME
          value: /usr/lib/jvm/java-17-openjdk
        - name: PATH
          value: /usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin:/home/tooling/.nvm/versions/node/v20.18.1/bin

      endpoints:
        - name: "react-app"
          targetPort: 3000
          exposure: public
          protocol: http
        - name: "vite-app"
          targetPort: 5173
          exposure: public
          protocol: http
        - name: "java-backend"
          targetPort: 8080
          exposure: public

# -------------------------------------------------------------------------
# 2. COMMANDS
# -------------------------------------------------------------------------
commands:
  # --- COMMAND 1: Install Only HCL DX Extension (From Local /opt) ---
  - id: install-local-dx-extension
    exec:
      label: "üîß Install Local HCL DX Extension"
      component: tools
      commandLine: |
        # Target directory for VS Code extensions
        EXT_DIR="$HOME/.vscode/extensions"
        mkdir -p "$EXT_DIR"
        
        echo "--> Scanning /opt/extensions for HCL DX..."

        # Loop to find specifically the HCL DX extension
        for vsix in /opt/extensions/*hcl-dx*.vsix; do
            if [ -f "$vsix" ]; then
                FILENAME=$(basename "$vsix" .vsix)
                TARGET="$EXT_DIR/$FILENAME"
                
                if [ -d "$TARGET" ]; then
                    echo "   ‚ö†Ô∏è  $FILENAME appears to be already installed. Skipping."
                else
                    echo "   üì¶ Unpacking HCL DX Extension: $FILENAME..."
                    # Unzip logic (robust method)
                    unzip -q "$vsix" -d "$TARGET.tmp"
                    if [ -d "$TARGET.tmp/extension" ]; then
                        mv "$TARGET.tmp/extension" "$TARGET"
                        rm -rf "$TARGET.tmp"
                        echo "      ‚úÖ Success: HCL DX installed."
                    else
                        echo "      ‚ùå Error: Invalid VSIX structure."
                    fi
                fi
            fi
        done
        echo "üéâ Local installation check complete. RELOAD WINDOW (F1 > Reload Window) to apply."

  # --- COMMAND 2: Load Sample Project ---
  - id: init-sample-project
    exec:
      label: "üöÄ Initialize HCL DX Sample"
      component: tools
      workingDir: /projects
      commandLine: |
        SOURCE="/opt/samples/dx-create-script-app"
        DEST="/projects/dx-create-script-app"

        if [ -d "$DEST" ]; then
            echo "‚ö†Ô∏è  FOLDER ALREADY EXISTS: $DEST"
        else
            echo "üìÇ Copying sample project from image..."
            cp -r "$SOURCE" "$DEST"
            echo "‚úÖ Project successfully created at: $DEST"
        fi

  # --- COMMAND 3: Diagnostic Check ---
  - id: check-versions
    exec:
      label: "üîç Check Tool Versions"
      component: tools
      workingDir: /projects
      commandLine: |
        echo "--- JAVA VERSION ---"
        java -version
        echo -e "\n--- NODE VERSION ---"
        node -v
        echo -e "\n--- HCL DX CLIENT ---"
        dxclient --version

  # --- COMMAND 4: Start React ---
  - id: start-react
    exec:
      label: "‚ñ∂Ô∏è Start React App"
      component: tools
      workingDir: ${PROJECT_SOURCE}
      commandLine: "npm start"

# -------------------------------------------------------------------------
# 3. EVENTS
# -------------------------------------------------------------------------
events:
  postStart:
    # Run the local installer automatically on startup
    - "install-local-dx-extension"
